<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <style type="text/css">
      body,html,#container{
        width: 100%;
        height: 100%;
        margin: 0px
      }
    </style>
    <title>中铁科建——郑州车库</title>
  </head>
  <body>
    <div id="container" tabindex="0"></div>
    <script type="text/javascript">
        window.init = function(){
            var map = new AMap.Map('container', {
           center: [113.760735,34.751837],
            viewMode: '3D',
            resizeEnable: true,
            rotateEnable: true,
            pitchEnable: true,
            pitch:45,
            rotation:25,
           // 隐藏默认楼块
           features: ['bg', 'road', 'point'],
           mapStyle: 'amap://styles/light',
             layers: [
            // 高德默认标准图层
            new AMap.TileLayer.Satellite(),
            // 楼块图层
            new AMap.Buildings({
                zooms: [16, 18],
                zIndex: 10,
                heightFactor: 2//2倍于默认高度，3D下有效
            })
        ],
        zoom: 18.5
     });

            if (location.href.indexOf('guide=1') !== -1) {
                map.setStatus({scrollWheel: false});
                map.plugin(["AMap.ToolBar"], function() {
                  map.addControl(new AMap.ToolBar({liteStyle:true}))
                });
            }
 
           AMap.plugin([
        'AMap.ControlBar',
    ], function(){

        // 添加 3D 罗盘控制
        map.addControl(new AMap.ControlBar());
    });
  
        // 添加 3D 雷达
    var object3Dlayer = new AMap.Object3DLayer();
    map.add(object3Dlayer);
  
    var radar;
    var buildRadar = function () {
        radar = new AMap.Object3D.Mesh();
        radar.transparent = true;
        radar.backOrFront = 'front';

        var geometry = radar.geometry;
        var radius = 250; // 米
        radius = radius / map.getResolution(map.getCenter(), 20);
        var unit = 1;
        var range = 200;
        var count = range / unit;

        for (var i = 0; i < count; i += 1) {
            var angle1 = i * unit * Math.PI / 180;
            var angle2 = (i + 1) * unit * Math.PI / 180;

            var p1x = Math.cos(angle1) * radius;
            var p1y = Math.sin(angle1) * radius;
            var p2x = Math.cos(angle2) * radius;
            var p2y = Math.sin(angle2) * radius;

            geometry.vertices.push(0, 0, 0);
            geometry.vertices.push(p1x, p1y, 0);
            geometry.vertices.push(p2x, p2y, 0);

            var opacityStart = getOpacity(i / count);
            var opacityEnd = getOpacity((i + 1) / count);

            geometry.vertexColors.push(0, 1, 0.2, opacityStart);
            geometry.vertexColors.push(0, 1, 0.2, opacityStart);
            geometry.vertexColors.push(0, 1, 0.2, opacityEnd);
        }

        radar.position(map.getCenter());

        object3Dlayer.add(radar);
    };

    function getOpacity(scale) {
        return 1 - Math.pow(scale, 0.3);
    }

    function scan() {
        radar.rotateZ(-2);
        AMap.Util.requestAnimFrame(scan);
    }

    buildRadar();
    scan();
  
    //模型
    var object3Dlayer = new AMap.Object3DLayer();
    map.add(object3Dlayer);

    var center_3d = map.lngLatToGeodeticCoord(map.getCenter());

    var topColor = [0, 1, 1, 0.9];
    var topFaceColor = [0, 1, 1, 0.4];
    var bottomColor = [0, 0, 1, 0.9];

    //添加一个圆柱体
    var addRegularPrism = function (center, segment, height, radius) {

        var cylinder = new AMap.Object3D.Mesh();
        var geometry = cylinder.geometry;
        var verticesLength = segment * 2;
        var path = []
        for (var i = 0; i < segment; i += 1) {
            var angle = 2 * Math.PI * i / segment;
            var x = center.x + Math.cos(angle) * radius;
            var y = center.y + Math.sin(angle) * radius;
            path.push([x, y]);
            geometry.vertices.push(x, y, 0); //底部顶点
            geometry.vertices.push(x, y, -height); //顶部顶点

            geometry.vertexColors.push.apply(geometry.vertexColors, bottomColor); //底部颜色
            geometry.vertexColors.push.apply(geometry.vertexColors, topColor); //顶部颜色

            var bottomIndex = i * 2;
            var topIndex = bottomIndex + 1;
            var nextBottomIndex = (bottomIndex + 2) % verticesLength;
            var nextTopIndex = (bottomIndex + 3) % verticesLength;

            geometry.faces.push(bottomIndex, topIndex, nextTopIndex); //侧面三角形1
            geometry.faces.push(bottomIndex, nextTopIndex, nextBottomIndex); //侧面三角形2
        }

        // 构建顶面三角形,为了区分顶面点和侧面点使用不一样的颜色,所以需要独立的顶点
        for (var i = 0; i < segment; i += 1) {
            geometry.vertices.push.apply(geometry.vertices, geometry.vertices.slice(i * 6 + 3, i * 6 + 6)); //底部顶点
            geometry.vertexColors.push.apply(geometry.vertexColors, topFaceColor);
        }

        var triangles = AMap.GeometryUtil.triangulateShape(path);
        var offset = segment * 2;

        for (var v = 0; v < triangles.length; v += 3) {
            geometry.faces.push(triangles[v] + offset, triangles[v + 2] + offset, triangles[v + 1] + offset);
        }

        cylinder.transparent = true; // 如果使用了透明颜色，请设置true
        object3Dlayer.add(cylinder);
    };
  
    addRegularPrism(center_3d.add(new AMap.Pixel(0, 0)), 32, 150, 80)//圆柱
    
    addRegularPrism(center_3d.add(new AMap.Pixel(200, 100)), 32, 150, 80) //圆柱2

		var A  = new AMap.Text({
			text:'1# 地下停车车库',
			position:[113.760735,34.751837],
			height:250,
			verticalAlign:'bottom',
			map:map,
			style:{
				'background-color':'white',
				'border-color':'white',
				'font-size':'12px'
			}
		})
        
 		var B  = new AMap.Text({
			text:'2# 地下停车车库',
			position:[113.761059,34.751695],
			height:250,
			verticalAlign:'bottom',
			map:map,
			style:{
				'background-color':'white',
				'border-color':'white',
				'font-size':'12px'
			}
		})
    
}
    </script>

    <script src="https://webapi.amap.com/maps?v=1.4.15&key=您申请的key值&callback=init"></script>
  </body>
</html>
